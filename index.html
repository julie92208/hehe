import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  query, 
  orderBy, 
  onSnapshot, 
  deleteDoc, 
  doc, 
  serverTimestamp,
  limit 
} from 'firebase/firestore';
import { 
  PlusCircle, 
  Trash2, 
  TrendingUp, 
  Users, 
  Wallet, 
  ArrowRightLeft,
  CheckCircle2,
  History,
  Settings
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Component ---
export default function CouplesWallet() {
  const [user, setUser] = useState(null);
  const [expenses, setExpenses] = useState([]);
  const [loading, setLoading] = useState(true);

  // Form State
  const [amount, setAmount] = useState('');
  const [desc, setDesc] = useState('');
  const [payer, setPayer] = useState('T'); // Default payer
  const [splitType, setSplitType] = useState('shared'); // 'shared' (50/50) or 'full' (100% for other)
  
  // Settings State (Modal)
  const [showSettings, setShowSettings] = useState(false);
  const [names, setNames] = useState({ p1: 'T', p2: 'J' });

  // 1. Auth & Initialization
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth error:", error);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
    });
    return () => unsubscribe();
  }, []);

  // 2. Load Data (Real-time)
  useEffect(() => {
    if (!user) return;

    // Using a PUBLIC collection so both users can see/edit the same list easily 
    // without complex invite flows for this artifact demo.
    const q = query(
      collection(db, 'artifacts', appId, 'public', 'data', 'expenses'),
      orderBy('timestamp', 'desc'),
      limit(50)
    );

    const unsubscribe = onSnapshot(q, 
      (snapshot) => {
        const data = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setExpenses(data);
        setLoading(false);
      },
      (error) => {
        console.error("Firestore error:", error);
        setLoading(false);
      }
    );

    return () => unsubscribe();
  }, [user]);

  // 3. Logic: Add Expense
  const handleAddExpense = async (e) => {
    e.preventDefault();
    if (!amount || !user) return;

    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), {
        amount: parseFloat(amount),
        description: desc || 'ä¸€èˆ¬æ¶ˆè²»',
        payer: payer, // 'p1' or 'p2' (stored as actual name key for simplicity in this demo, or just string)
        payerName: payer === 'p1' ? names.p1 : names.p2, // Snapshot name at time of entry
        splitType, // 'shared' or 'full'
        timestamp: serverTimestamp(),
        userId: user.uid
      });

      // Reset form
      setAmount('');
      setDesc('');
      // Keep payer same for rapid entry? Or reset? Let's keep it.
    } catch (err) {
      console.error("Error adding doc:", err);
      alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  };

  // 4. Logic: Delete Expense
  const handleDelete = async (id) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id));
    } catch (err) {
      console.error("Delete error:", err);
    }
  };

  // 5. Logic: Calculate Balance
  const balance = useMemo(() => {
    let p1Paid = 0;
    let p2Paid = 0;
    let p1ShouldPay = 0;
    let p2ShouldPay = 0;

    expenses.forEach(item => {
      const amt = item.amount || 0;
      const isP1 = item.payer === 'p1' || item.payerName === names.p1 || item.payer === names.p1; // Handle legacy/string variations safely
      
      // Track total outflow
      if (isP1) p1Paid += amt;
      else p2Paid += amt;

      // Track liability
      if (item.splitType === 'shared') {
        p1ShouldPay += amt / 2;
        p2ShouldPay += amt / 2;
      } else {
        // Full amount for the OTHER person
        if (isP1) {
          // P1 paid for P2
          p2ShouldPay += amt; 
        } else {
          // P2 paid for P1
          p1ShouldPay += amt;
        }
      }
    });

    // Net: (Paid - ShouldPay) -> Positive means you are OWED money. Negative means you OWE.
    const p1Net = p1Paid - p1ShouldPay;
    
    return {
      p1Net,
      msg: p1Net === 0 
        ? "å¸³ç›®å·²çµæ¸…ï¼" 
        : p1Net > 0 
          ? `${names.p2} éœ€çµ¦ ${names.p1}` 
          : `${names.p1} éœ€çµ¦ ${names.p2}`,
      absAmount: Math.abs(p1Net).toFixed(1) // Keep decimals manageable
    };
  }, [expenses, names]);

  if (loading) {
    return <div className="flex h-screen items-center justify-center bg-gray-50 text-gray-400">è¼‰å…¥ä¸­...</div>;
  }

  return (
    <div className="min-h-screen bg-gray-50 pb-20 font-sans text-gray-800">
      {/* Header */}
      <div className="bg-white px-6 pt-8 pb-6 shadow-sm sticky top-0 z-10">
        <div className="flex justify-between items-center mb-4">
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <Wallet className="w-6 h-6 text-indigo-600" />
            åˆ†å¸³ç¥å™¨
          </h1>
          <button 
            onClick={() => setShowSettings(!showSettings)}
            className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition"
          >
            <Settings className="w-5 h-5 text-gray-600" />
          </button>
        </div>

        {/* Balance Card */}
        <div className={`rounded-2xl p-6 text-white shadow-lg transition-all duration-300 ${balance.absAmount == 0 ? 'bg-gradient-to-r from-emerald-400 to-teal-500' : 'bg-gradient-to-r from-indigo-500 to-purple-600'}`}>
          <div className="flex items-center gap-2 text-indigo-100 mb-1">
            <TrendingUp className="w-4 h-4 text-white" />
            <span className="text-sm font-medium text-white/90">ç›®å‰çš„çµç®—ç‹€æ…‹</span>
          </div>
          <div className="flex items-baseline gap-2 mt-2">
             {balance.absAmount == 0 ? (
                <span className="text-3xl font-bold">ç›®å‰å…©æ¸…ï¼ğŸ‰</span>
             ) : (
               <>
                <span className="text-lg opacity-90">{balance.msg}</span>
                <span className="text-4xl font-bold tracking-tight">${balance.absAmount}</span>
               </>
             )}
          </div>
        </div>
      </div>

      {/* Settings Modal */}
      {showSettings && (
        <div className="mx-4 mt-4 p-4 bg-white rounded-xl shadow-sm border border-gray-100 animate-in fade-in slide-in-from-top-4">
           <h3 className="font-semibold mb-3 text-gray-700">è¨­å®šæš±ç¨±</h3>
           <div className="flex gap-2">
             <input 
               value={names.p1} 
               onChange={(e) => setNames({...names, p1: e.target.value})}
               className="w-1/2 p-2 border rounded-lg text-center"
               placeholder="ä½ "
             />
             <input 
               value={names.p2} 
               onChange={(e) => setNames({...names, p2: e.target.value})}
               className="w-1/2 p-2 border rounded-lg text-center"
               placeholder="å¥³å‹"
             />
           </div>
           <p className="text-xs text-gray-400 mt-2 text-center">ä¿®æ”¹å¾Œåƒ…å½±éŸ¿é¡¯ç¤ºï¼Œä¸å½±éŸ¿æ­·å²ç´€éŒ„è¨ˆç®—</p>
        </div>
      )}

      {/* Quick Add Form */}
      <div className="px-4 mt-6">
        <form onSubmit={handleAddExpense} className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
          <div className="mb-4">
            <label className="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">é‡‘é¡</label>
            <div className="relative">
              <span className="absolute left-0 top-1 text-2xl text-gray-400 font-light">$</span>
              <input
                type="number"
                inputMode="decimal"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                placeholder="0"
                className="w-full pl-6 text-4xl font-bold text-gray-800 placeholder-gray-200 outline-none border-b border-gray-100 pb-2 focus:border-indigo-500 transition-colors"
                autoFocus
              />
            </div>
          </div>

          <div className="mb-5">
            <input
              type="text"
              value={desc}
              onChange={(e) => setDesc(e.target.value)}
              placeholder="è¼¸å…¥é …ç›® (ä¾‹å¦‚: æ™šé¤)"
              className="w-full bg-gray-50 rounded-lg px-4 py-3 text-gray-700 outline-none focus:ring-2 focus:ring-indigo-100 transition"
            />
          </div>

          <div className="grid grid-cols-2 gap-3 mb-6">
            {/* Who Paid? */}
            <div className="space-y-2">
              <label className="text-xs font-medium text-gray-500 flex items-center gap-1">
                <Users className="w-3 h-3" /> èª°ä»˜éŒ¢?
              </label>
              <div className="flex bg-gray-100 p-1 rounded-lg">
                <button
                  type="button"
                  onClick={() => setPayer('p1')}
                  className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${payer === 'p1' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                >
                  {names.p1}
                </button>
                <button
                  type="button"
                  onClick={() => setPayer('p2')}
                  className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${payer === 'p2' ? 'bg-white text-pink-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                >
                  {names.p2}
                </button>
              </div>
            </div>

            {/* Split Type */}
            <div className="space-y-2">
              <label className="text-xs font-medium text-gray-500 flex items-center gap-1">
                <ArrowRightLeft className="w-3 h-3" /> æ€éº¼åˆ†?
              </label>
              <div className="flex bg-gray-100 p-1 rounded-lg">
                <button
                  type="button"
                  onClick={() => setSplitType('shared')}
                  className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${splitType === 'shared' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                >
                  å¹³åˆ†
                </button>
                <button
                  type="button"
                  onClick={() => setSplitType('full')}
                  className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${splitType === 'full' ? 'bg-white text-orange-500 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                >
                  è«‹å®¢/ä»£å¢Š
                </button>
              </div>
            </div>
          </div>

          <button
            type="submit"
            disabled={!amount}
            className={`w-full py-4 rounded-xl font-bold text-lg shadow-md flex items-center justify-center gap-2 transition-transform active:scale-[0.98] ${
              amount 
                ? 'bg-indigo-600 text-white hover:bg-indigo-700' 
                : 'bg-gray-200 text-gray-400 cursor-not-allowed'
            }`}
          >
            <PlusCircle className="w-5 h-5" />
            è¨˜ä¸€ç­†
          </button>
        </form>
      </div>

      {/* Recent History */}
      <div className="px-6 mt-10">
        <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
          <History className="w-4 h-4" />
          æœ€è¿‘ç´€éŒ„
        </h3>
        
        <div className="space-y-3">
          {expenses.length === 0 ? (
            <div className="text-center py-10 text-gray-400 bg-white rounded-xl border border-dashed border-gray-200">
              é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»åƒé “å¥½æ–™çš„å§ï¼ğŸœ
            </div>
          ) : (
            expenses.map((item) => {
              const isShared = item.splitType === 'shared';
              const itemPayerName = item.payer === 'p1' ? names.p1 : names.p2;
              
              return (
                <div key={item.id} className="group flex items-center justify-between bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-all">
                  <div className="flex items-center gap-4">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold shrink-0 ${
                      item.payer === 'p1' ? 'bg-indigo-50 text-indigo-600' : 'bg-pink-50 text-pink-600'
                    }`}>
                      {item.payer === 'p1' ? names.p1[0] : names.p2[0]}
                    </div>
                    <div>
                      <div className="font-bold text-gray-800">{item.description}</div>
                      <div className="text-xs text-gray-500 flex items-center gap-1 mt-0.5">
                        <span>{itemPayerName} ä»˜äº† ${item.amount}</span>
                        <span className="w-1 h-1 rounded-full bg-gray-300"></span>
                        <span className={`${isShared ? 'text-green-600' : 'text-orange-500'}`}>
                          {isShared ? 'å¹³åˆ†' : 'å¹«å°æ–¹ä»˜'}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  <div className="flex items-center gap-3">
                    <button 
                      onClick={() => handleDelete(item.id)}
                      className="p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition opacity-0 group-hover:opacity-100"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}
